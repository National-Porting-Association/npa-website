/*
    Mobile Controller Library by NPA
    All rights reserved.
    Version: 1.0.0
*/
const MobileController=function(){let e={targetSelector:"canvas",debug:!1,leftJoystick:{deadzone:12,maxDistance:80,mapping:{up:"w",down:"s",left:"a",right:"d"}},rightJoystick:{sensitivity:2,maxDistance:100},leftButtons:[{id:"btn-blank-left-1",label:"",type:"key",hold:!1},{id:"btn-blank-left-2",label:"",type:"key",hold:!1},{id:"btn-leftclick",label:"LMB",type:"mouse",button:0,hold:!0},{id:"btn-ctrl",label:"Ctrl",type:"key",key:"Control",hold:!0}],rightButtons:[{id:"btn-blank-right-1",label:"",type:"key",hold:!1},{id:"btn-blank-right-2",label:"",type:"key",hold:!1},{id:"btn-rightclick",label:"RMB",type:"mouse",button:2,hold:!0},{id:"btn-jump",label:"Jump",type:"key",key:" ",hold:!1}],centerButtons:[{id:"btn-f",label:"F",type:"key",key:"f",hold:!1},{id:"btn-r",label:"R",type:"key",key:"r",hold:!1},{id:"btn-q",label:"Q",type:"key",key:"q",hold:!1},{id:"btn-e",label:"E",type:"key",key:"e",hold:!1}],styles:{containerZIndex:2147483647}},t=new Set,n=new Set,o=new Map,l=null,i=null,a=null,s=null,r=null,c=null,d=null,p=!1,u=null,f=null,y=null;function m(e,t,n){return Math.max(t,Math.min(n,e))}function h(e,t){var n;let{code:o,keyCode:l}=" "===(n=t)?{code:"Space",keyCode:32}:"Shift"===n?{code:"ShiftLeft",keyCode:16}:"Control"===n?{code:"ControlLeft",keyCode:17}:/^[a-zA-Z]$/.test(n)?{code:"Key"+n.toUpperCase(),keyCode:n.toUpperCase().charCodeAt(0)}:/^[0-9]$/.test(n)?{code:"Digit"+n,keyCode:n.charCodeAt(0)}:{code:n,keyCode:0},i=new KeyboardEvent(e,{key:t,code:o,keyCode:l,which:l,bubbles:!0,cancelable:!0});try{document.dispatchEvent(i)}catch(a){}}let b=0;function g(t,n){let o=Date.now();if(o-b<5)return;b=o;let l={bubbles:!0,cancelable:!0,pointerId:1,pointerType:"touch",movementX:t*e.rightJoystick.sensitivity,movementY:n*e.rightJoystick.sensitivity},i=new PointerEvent("pointermove",l),a=new MouseEvent("mousemove",{bubbles:!0,cancelable:!0,movementX:t*e.rightJoystick.sensitivity,movementY:n*e.rightJoystick.sensitivity});if(y){try{y.dispatchEvent(i)}catch(s){}try{y.dispatchEvent(a)}catch(r){}}}function v(e,t){if(y)try{y.dispatchEvent(new MouseEvent("down"===e?"mousedown":"mouseup",{bubbles:!0,cancelable:!0,button:t}))}catch(n){}}function x(n,o){let l=e.leftJoystick.mapping,a=e.leftJoystick.deadzone;if(Math.hypot(n,o)<a){k(),i&&(i.style.transform="translate(0px,0px)");return}let s=e.leftJoystick.maxDistance,r=m(n/s,-1,1),c=m(o/s,-1,1),d=new Set;for(let p of(-c>.35&&d.add(l.up),c>.35&&d.add(l.down),r<-.35&&d.add(l.left),r>.35&&d.add(l.right),i&&(i.style.transform=`translate(${m(n,-s,s)}px, ${m(o,-s,s)}px)`),Array.from(t)))!d.has(p)&&Object.values(l).includes(p)&&(t.delete(p),h("keyup",p));for(let u of Array.from(d))t.has(u)||(t.add(u),h("keydown",u))}function k(){let n=Object.values(e.leftJoystick.mapping);for(let o of n)t.has(o)&&(t.delete(o),h("keyup",o))}function $(t,n){let o=e.rightJoystick.maxDistance,l=m(t,-o,o),i=m(n,-o,o);s&&(s.style.transform=`translate(${l}px, ${i}px)`),g(t,n)}function _(e){var t;let n=document.createElement("div");return n.className="mc-btn",n.id=e.id,n.textContent=e.label,n.draggable=!1,n.setAttribute("role","button"),n.setAttribute("aria-label",e.label||"Blank Button"),n.style.userSelect="none",n.style.webkitUserSelect="none",n.style.MozUserSelect="none",n.style.msUserSelect="none",n.style.webkitTouchCallout="none",n.style.webkitUserDrag="none",n.ondragstart=()=>!1,(t=n)&&(t.addEventListener("selectstart",e=>{e.preventDefault()}),t.addEventListener("copy",e=>{e.preventDefault()}),t.addEventListener("cut",e=>{e.preventDefault()}),t.addEventListener("dragstart",e=>{e.preventDefault()}),t.addEventListener("contextmenu",e=>{e.preventDefault()})),n.addEventListener("pointermove",e=>{e.preventDefault(),e.stopPropagation()},{passive:!1}),n.addEventListener("touchmove",e=>{e.preventDefault(),e.stopPropagation()},{passive:!1}),n.addEventListener("contextmenu",e=>{e.preventDefault(),e.stopPropagation()}),n}function w(e){for(let t of Array.from(e.changedTouches)){let n=t.clientX,i=t.clientY,s=l.getBoundingClientRect(),r=a.getBoundingClientRect(),c=n>=s.left&&n<=s.right&&i>=s.top&&i<=s.bottom,d=n>=r.left&&n<=r.right&&i>=r.top&&i<=r.bottom;if(c){let p=n-(s.left+s.width/2),u=i-(s.top+s.height/2);o.set(t.identifier,{type:"left",startX:n,startY:i,lastX:n,lastY:i}),x(p,u)}else if(d){let f=n-(r.left+r.width/2),y=t.clientY-(r.top+r.height/2);o.set(t.identifier,{type:"right",startX:n,startY:i,lastX:n,lastY:i}),$(f,y)}}e.preventDefault(),e.stopPropagation()}function C(t){for(let n of Array.from(t.changedTouches))if(o.has(n.identifier)){let i=o.get(n.identifier);if("left"===i.type){let r=l.getBoundingClientRect(),c=n.clientX-(r.left+r.width/2),d=n.clientY-(r.top+r.height/2);x(c,d)}else if("right"===i.type){let p=i.lastX,u=i.lastY;i.lastX=n.clientX,i.lastY=n.clientY;let f=n.clientX-p,y=n.clientY-u,h=a.getBoundingClientRect(),b=n.clientX-(h.left+h.width/2),v=n.clientY-(h.top+h.height/2),k=e.rightJoystick.maxDistance,$=m(b,-k,k),_=m(v,-k,k);s&&(s.style.transform=`translate(${$}px, ${_}px)`),g(f,y)}}t.preventDefault(),t.stopPropagation()}function E(e){for(let t of Array.from(e.changedTouches))if(o.has(t.identifier)){let n=o.get(t.identifier);"left"===n.type?(i.style.transition="transform 0.12s ease-out",i.style.transform="translate(0px,0px)",k()):"right"===n.type&&(s.style.transition="transform 0.12s ease-out",s.style.transform="translate(0px, 0px)"),o.delete(t.identifier)}e.preventDefault(),e.stopPropagation()}function D(e){"key"===e.type?e.hold?t.has(e.key)||(t.add(e.key),h("keydown",e.key)):(h("keydown",e.key),h("keyup",e.key)):"mouse"!==e.type||(e.hold?n.has(e.button)||(n.add(e.button),v("down",e.button)):(v("down",e.button),v("up",e.button)))}function L(e){"key"===e.type?e.hold&&t.has(e.key)&&(t.delete(e.key),h("keyup",e.key)):"mouse"===e.type&&e.hold&&n.has(e.button)&&(n.delete(e.button),v("up",e.button))}function J(){p||(p=!0,function t(){if(!f){for(let n of(function t(){if(document.getElementById("mobile-controller-styles"))return;let n=document.createElement("style");n.id="mobile-controller-styles",n.textContent=`
      #mobile-controller-root{position:fixed;left:0;top:0;right:0;bottom:0;pointer-events:none;z-index:${e.styles.containerZIndex};-webkit-user-select:none;-webkit-touch-callout:none}
      .mc-area{pointer-events:auto}
      .mc-joy{position:absolute;border-radius:50%;background:rgba(0,0,0,0.18);display:flex;align-items:center;justify-content:center;pointer-events:auto;touch-action:none;overflow:visible}
      .mc-knob{width:64px;height:64px;border-radius:50%;background:rgba(255,255,255,0.12);box-shadow:0 6px 18px rgba(0,0,0,0.4);transition:transform 0.02s linear;pointer-events:none}
      .mc-buttons{position:fixed;display:flex;flex-direction:column;gap:12px;pointer-events:auto;z-index:${e.styles.containerZIndex}}
      .mc-left-buttons{
        left: 12px;
        bottom: calc(12px + ${2*e.leftJoystick.maxDistance}px + 12px);
        display: grid;
        grid-template-columns: repeat(2, 70px);
        grid-auto-rows: 50px;
        gap: 12px;
        transform: translateY(-24px);
      }
      .mc-right-buttons{
        right: 12px;
        bottom: calc(12px + ${2*e.rightJoystick.maxDistance}px + 12px);
        display: grid;
        grid-template-columns: repeat(2, 70px);
        grid-auto-rows: 50px;
        gap: 12px;
        transform: translateY(-24px);
      }
      .mc-center-buttons{
        position:fixed;
        left:50%;
        transform:translateX(-50%);
        bottom:12px;
        display:flex;
        flex-direction:row;
        gap:12px;
        align-items:center;
        justify-content:center;
        pointer-events:auto;
        z-index:${e.styles.containerZIndex}
      }
      .mc-btn{width:70px;height:50px;padding:8px 10px;font-size:14px;border-radius:10px;background:rgba(0,0,0,0.28);color:white;text-align:center;user-select:none;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;-webkit-touch-callout:none;-webkit-user-drag:none;user-drag:none;touch-action:none;display:flex;align-items:center;justify-content:center}
      .mc-btn:active{transform:scale(0.98)}
    `,document.head.appendChild(n)}(),(f=document.createElement("div")).id="mobile-controller-root",f.style.display="block",y=function t(){try{let n=document.querySelector(e.targetSelector);if(n)return n}catch(o){}return document}(),(l=document.createElement("div")).className="mc-joy mc-area",l.style.left="12px",l.style.bottom="12px",l.style.width=2*e.leftJoystick.maxDistance+"px",l.style.height=2*e.leftJoystick.maxDistance+"px",(i=document.createElement("div")).className="mc-knob",i.style.touchAction="none",l.appendChild(i),f.appendChild(l),(a=document.createElement("div")).className="mc-joy mc-area",a.style.right="12px",a.style.bottom="12px",a.style.width=2*e.rightJoystick.maxDistance+"px",a.style.height=2*e.rightJoystick.maxDistance+"px",(s=document.createElement("div")).className="mc-knob",s.style.touchAction="none",a.appendChild(s),f.appendChild(a),(r=document.createElement("div")).className="mc-buttons mc-left-buttons mc-area",document.body.appendChild(r),(c=document.createElement("div")).className="mc-buttons mc-right-buttons mc-area",document.body.appendChild(c),(d=document.createElement("div")).className="mc-buttons mc-center-buttons mc-area",document.body.appendChild(d),e.leftButtons.filter(e=>e.label))){let o=_(n);r.appendChild(o),o.addEventListener("pointerdown",e=>{e.preventDefault(),e.stopPropagation(),D(n),o.classList.add("mc-pressed")},{passive:!1}),o.addEventListener("pointerup",e=>{e.preventDefault(),e.stopPropagation(),L(n),o.classList.remove("mc-pressed")},{passive:!1})}for(let p of e.rightButtons.filter(e=>e.label)){let u=_(p);c.appendChild(u),u.addEventListener("pointerdown",e=>{e.preventDefault(),e.stopPropagation(),D(p),u.classList.add("mc-pressed")},{passive:!1}),u.addEventListener("pointerup",e=>{e.preventDefault(),e.stopPropagation(),L(p),u.classList.remove("mc-pressed")},{passive:!1})}for(let m of e.centerButtons.filter(e=>e.label)){let h=_(m);d.appendChild(h),h.addEventListener("pointerdown",e=>{e.preventDefault(),e.stopPropagation(),D(m),h.classList.add("mc-pressed")},{passive:!1}),h.addEventListener("pointerup",e=>{e.preventDefault(),e.stopPropagation(),L(m),h.classList.remove("mc-pressed")},{passive:!1})}document.body.appendChild(f),f.addEventListener("touchstart",w,{passive:!1}),f.addEventListener("touchmove",C,{passive:!1}),f.addEventListener("touchend",E,{passive:!1}),f.addEventListener("touchcancel",E,{passive:!1})}}(),f.style.display="block",function t(...n){e.debug&&console.log("[MC]",...n)}("MobileController initialized and visible"))}function S(){u&&(u.disconnect(),u=null)}return{init:J,setConfig:function t(n){Object.assign(e,n)},CONFIG:e,_internal:{startAutoInitWatcher:function t(){try{if(document.querySelector(e.targetSelector)){J(),S();return}}catch(n){}(u=new MutationObserver(t=>{for(let n of t)for(let o of Array.from(n.addedNodes))try{if(o instanceof Element&&(o.matches&&o.matches(e.targetSelector)||o.querySelector&&o.querySelector(e.targetSelector))){J(),S();return}}catch(l){}})).observe(document.documentElement||document.body,{childList:!0,subtree:!0})}}}}();try{MobileController._internal.startAutoInitWatcher()}catch(e){console.error("MobileController auto-init failed",e)}